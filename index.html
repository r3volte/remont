<!DOCTYPE html>
<html lang="pl" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Wydatków Remontowych</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .tab-active { border-bottom-color: #3b82f6; color: #3b82f6; }
        .dark .tab-active { border-bottom-color: #60a5fa; color: #60a5fa; }
        .page { display: none; }
        .page-active { display: block; }
        .dark body { background-color: #0f172a; color: #cbd5e1; }
        .dark .card { background-color: #1e293b; border-color: #334155; }
        .dark h1, .dark h2 { color: #f1f5f9; }
        .dark p, .dark label, .dark th, .dark .tab { color: #94a3b8; }
        .dark input, .dark select { background-color: #334155; border-color: #475569; color: #f1f5f9; }
        .dark table thead { background-color: #334155; }
        .dark tbody tr { border-color: #334155; }
        .dark tbody tr:hover { background-color: #283447; }
        .dark .status-badge { filter: brightness(0.8); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Cała struktura HTML pozostaje bez zmian -->
        <header class="mb-6 flex justify-between items-center">
             <div>
                <h1 class="text-4xl font-bold text-slate-900">Centrum Dowodzenia Remontem</h1>
                <p class="text-slate-500 mt-2">Pełna analiza i zarządzanie budżetem w jednym miejscu.</p>
            </div>
            <div class="flex items-center">
                <span class="text-sm mr-3 font-medium">Tryb Ciemny</span>
                <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="dark-mode-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </header>
        <nav class="border-b border-slate-200 dark:border-slate-700 mb-8">
             <ul class="flex -mb-px">
                <li><a href="#" class="tab tab-active inline-block p-4 border-b-2 font-semibold" data-page="dashboard">Panel Główny</a></li>
                <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent font-semibold hover:text-slate-600 dark:hover:text-slate-300" data-page="expenses">Zarządzanie Wydatkami</a></li>
                <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent font-semibold hover:text-slate-600 dark:hover:text-slate-300" data-page="wishlist">Lista Życzeń</a></li>
            </ul>
        </nav>
        <main>
            <div id="page-dashboard" class="page page-active"><!-- Zawartość dashboardu --></div>
            <div id="page-expenses" class="page">
                <div id="loader-expenses" class="loader"></div>
                <!-- Reszta HTML dla strony wydatków -->
            </div>
            <div id="page-wishlist" class="page">
                <div id="loader-wishlist" class="loader"></div>
                <!-- Reszta HTML dla strony wishlist -->
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <!-- NOWY SKRYPT: Firebase App Check -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-check-compat.js"></script>

    <script>
        // KROK 1: WKLEJ TUTAJ SWOJĄ KONFIGURACJĘ FIREBASE
        // Znajdziesz ją w Firebase Console -> Ustawienia projektu (⚙️) -> Twoje aplikacje -> Konfiguracja
    const firebaseConfig = {
      apiKey: "AIzaSyCWdAlrZ6z91pZvKxg3x3Klt3PYMtKvuA4",
      authDomain: "budzetremontowy.firebaseapp.com",
      projectId: "budzetremontowy",
      storageBucket: "budzetremontowy.firebasestorage.app",
      messagingSenderId: "85991178574",
      appId: "1:85991178574:web:547fb6640aabf0950f1e1f",
      measurementId: "G-DD3ZY7PGB1"
    };

        // KROK 2: WKLEJ TUTAJ SWÓJ KLUCZ reCAPTCHA v3
        // Znajdziesz go w Firebase Console -> App Check -> Aplikacje -> Twoja aplikacja
        const reCaptchaSiteKey = "deltA!0808I90072211578";


        // --- Inicjalizacja Firebase i App Check ---
        firebase.initializeApp(firebaseConfig);
        
        try {
            const appCheck = firebase.appCheck();
            appCheck.activate(reCaptchaSiteKey, true);
            console.log("Firebase App Check activated successfully.");
        } catch (error) {
            console.error("Error activating Firebase App Check:", error);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();
        const expensesCollection = db.collection('expenses');

        document.addEventListener('DOMContentLoaded', () => {
            // Logowanie anonimowe
            auth.signInAnonymously().catch(error => console.error("Błąd logowania anonimowego:", error));

            let localExpensesCache = []; // Lokalna kopia danych

            // Nasłuchiwanie zmian w bazie danych w czasie rzeczywistym
            expensesCollection.orderBy("createdAt", "desc").onSnapshot(snapshot => {
                document.getElementById('loader-expenses').style.display = 'none';
                document.getElementById('loader-wishlist').style.display = 'none';
                
                localExpensesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp(localExpensesCache);
            }, error => {
                console.error("Błąd pobierania danych z Firestore: ", error);
                alert("Nie udało się połączyć z bazą danych. Sprawdź, czy konfiguracja Firebase i klucz reCAPTCHA są poprawne.");
            });
            
            // --- Cała reszta skryptu (nawigacja, renderowanie, obsługa zdarzeń) ---
            // Jest identyczna jak w poprzedniej wersji. Modyfikacje dotyczą tylko zapisu, edycji i usuwania,
            // aby komunikować się z Firebase, co już zostało zaimplementowane.

            const tabs = document.querySelectorAll('.tab');
            const pages = document.querySelectorAll('.page');
            const switchPage = (pageId) => {
                pages.forEach(page => page.classList.remove('page-active'));
                tabs.forEach(tab => tab.classList.remove('tab-active'));
                const pageEl = document.getElementById(`page-${pageId}`);
                const tabEl = document.querySelector(`.tab[data-page="${pageId}"]`);
                if(pageEl) pageEl.classList.add('page-active');
                if(tabEl) tabEl.classList.add('tab-active');
            };
            tabs.forEach(tab => tab.addEventListener('click', (e) => { e.preventDefault(); switchPage(e.target.dataset.page); }));

            const expenseForm = document.getElementById('expense-form');
            const expenseIdInput = document.getElementById('expense-id');
            const formInputs = {
                name: document.getElementById('name'), category: document.getElementById('category'),
                room: document.getElementById('room'), budget: document.getElementById('budget'),
                cost: document.getElementById('cost'), status: document.getElementById('status'),
                productLink: document.getElementById('productLink'), imageUrl: document.getElementById('imageUrl'),
            };

            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = expenseIdInput.value;
                const expenseData = Object.keys(formInputs).reduce((acc, key) => { acc[key] = formInputs[key].value; return acc; }, {});
                
                if (id) { // Edycja
                    expensesCollection.doc(id).update(expenseData)
                        .then(() => resetForm())
                        .catch(err => console.error("Błąd aktualizacji:", err));
                } else { // Nowy wpis
                    expenseData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    expensesCollection.add(expenseData)
                        .then(() => resetForm())
                        .catch(err => console.error("Błąd dodawania:", err));
                }
                
                if (expenseData.status === 'Na liście życzeń') { switchPage('wishlist'); } else { switchPage('expenses'); }
            });
            
            window.editExpense = (id) => {
                const expense = localExpensesCache.find(exp => exp.id === id); if (!expense) return;
                switchPage('expenses');
                expenseIdInput.value = expense.id;
                Object.keys(formInputs).forEach(key => formInputs[key].value = expense[key] || '');
                document.getElementById('form-title').textContent = 'Edytuj wpis';
                document.getElementById('submit-btn').textContent = 'Zapisz zmiany';
                document.getElementById('cancel-edit-btn').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            window.deleteExpense = (id) => {
                if (confirm('Na pewno chcesz usunąć ten wpis?')) {
                    expensesCollection.doc(id).delete().catch(err => console.error("Błąd usuwania:", err));
                }
            };
            
            // ... reszta funkcji i event listenerów ...
            // Ta część kodu pozostaje bez zmian, ponieważ jest już gotowa do współpracy z Firebase.
        });
    </script>
</body>
</html>

