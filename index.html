<!DOCTYPE html>
<html lang="pl" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Wydatków Remontowych</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .tab-active { border-bottom-color: #3b82f6; color: #3b82f6; }
        .dark .tab-active { border-bottom-color: #60a5fa; color: #60a5fa; }
        .page { display: none; }
        .page-active { display: block; }
        .dark body { background-color: #0f172a; color: #cbd5e1; }
        .dark .card { background-color: #1e293b; border-color: #334155; }
        .dark h1, .dark h2 { color: #f1f5f9; }
        .dark p, .dark label, .dark th, .dark .tab { color: #94a3b8; }
        .dark input, .dark select { background-color: #334155; border-color: #475569; color: #f1f5f9; }
        .dark table thead { background-color: #334155; }
        .dark tbody tr { border-color: #334155; }
        .dark tbody tr:hover { background-color: #283447; }
        .dark .status-badge { filter: brightness(0.8); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Nagłówek i reszta HTML bez zmian... -->
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-slate-900">Centrum Dowodzenia Remontem</h1>
                <p class="text-slate-500 mt-2">Pełna analiza i zarządzanie budżetem w jednym miejscu.</p>
            </div>
            <div class="flex items-center">
                <span class="text-sm mr-3 font-medium">Tryb Ciemny</span>
                <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" value="" id="dark-mode-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </header>

        <nav class="border-b border-slate-200 dark:border-slate-700 mb-8">
             <ul class="flex -mb-px">
                <li><a href="#" class="tab tab-active inline-block p-4 border-b-2 font-semibold" data-page="dashboard">Panel Główny</a></li>
                <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent font-semibold hover:text-slate-600 dark:hover:text-slate-300" data-page="expenses">Zarządzanie Wydatkami</a></li>
                <li><a href="#" class="tab inline-block p-4 border-b-2 border-transparent font-semibold hover:text-slate-600 dark:hover:text-slate-300" data-page="wishlist">Lista Życzeń</a></li>
            </ul>
        </nav>

        <main>
             <!-- Wszystkie strony (pages) i ich zawartość pozostają bez zmian -->
            <div id="page-dashboard" class="page page-active">
                <section id="summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card bg-white p-6 rounded-xl shadow-md border"><h3 class="text-sm font-semibold uppercase">Budżet całkowity</h3><p id="total-budget" class="text-3xl font-bold text-blue-600 mt-2">15 000,00 zł</p></div>
                    <div class="card bg-white p-6 rounded-xl shadow-md border"><h3 class="text-sm font-semibold uppercase">Wydano</h3><p id="total-spent" class="text-3xl font-bold text-green-600 mt-2">0,00 zł</p></div>
                    <div class="card bg-white p-6 rounded-xl shadow-md border"><h3 class="text-sm font-semibold uppercase">Pozostało</h3><p id="difference" class="text-3xl font-bold text-slate-700 mt-2">15 000,00 zł</p></div>
                </section>
                <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card bg-white p-6 rounded-xl shadow-md border"><h2 class="text-xl font-bold text-slate-900 mb-4">Wydatki wg kategorii</h2><canvas id="categoryPieChart"></canvas></div>
                    <div class="card bg-white p-6 rounded-xl shadow-md border"><h2 class="text-xl font-bold text-slate-900 mb-4">Plan vs Rzeczywistość</h2><canvas id="budgetBarChart"></canvas></div>
                </section>
            </div>
            <div id="page-expenses" class="page">
                 <div id="loader-expenses" class="loader"></div>
                 <!-- Reszta HTML dla strony wydatków -->
                 <section class="card bg-white p-6 rounded-xl shadow-md border mb-8">
                    <h2 id="form-title" class="text-xl font-bold text-slate-900 mb-4">Dodaj nowy wpis</h2>
                    <form id="expense-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <input type="hidden" id="expense-id">
                        <div><label for="name" class="block text-sm font-medium mb-1">Nazwa / Opis</label><input type="text" id="name" class="w-full px-3 py-2 border rounded-md" required></div>
                        <div><label for="category" class="block text-sm font-medium mb-1">Kategoria</label><select id="category" class="w-full px-3 py-2 border rounded-md" required><option>Meble</option><option>AGD/RTV</option><option>Materiały budowlane</option><option>Oświetlenie</option><option>Dekoracje i tekstylia</option><option>Narzędzia i akcesoria</option><option>Usługi</option><option>Kuchnia - wyposażenie</option><option>Łazienka - wyposażenie</option><option>Inne</option></select></div>
                        <div><label for="room" class="block text-sm font-medium mb-1">Pomieszczenie</label><input type="text" id="room" class="w-full px-3 py-2 border rounded-md"></div>
                        <div><label for="budget" class="block text-sm font-medium mb-1">Budżet (Plan)</label><input type="number" id="budget" step="0.01" class="w-full px-3 py-2 border rounded-md"></div>
                        <div><label for="cost" class="block text-sm font-medium mb-1">Koszt Rzeczywisty</label><input type="number" id="cost" step="0.01" class="w-full px-3 py-2 border rounded-md"></div>
                        <div><label for="status" class="block text-sm font-medium mb-1">Status</label><select id="status" class="w-full px-3 py-2 border rounded-md" required><option>Na liście życzeń</option><option>Do kupienia</option><option>Zamówione</option><option>Dostarczone / Zakończone</option></select></div>
                        <div class="md:col-span-1"><label for="productLink" class="block text-sm font-medium mb-1">Link do produktu</label><input type="url" id="productLink" class="w-full px-3 py-2 border rounded-md"></div>
                        <div class="md:col-span-2"><label for="imageUrl" class="block text-sm font-medium mb-1">URL zdjęcia / paragonu</label><input type="url" id="imageUrl" class="w-full px-3 py-2 border rounded-md"></div>
                        <div class="md:col-span-2 lg:col-span-3 flex justify-end items-center gap-4"><button type="button" id="cancel-edit-btn" class="hidden px-6 py-2 text-sm font-semibold bg-slate-200 rounded-md">Anuluj</button><button type="submit" id="submit-btn" class="px-6 py-2 font-semibold text-white bg-blue-600 rounded-md">Dodaj wpis</button></div>
                    </form>
                </section>
                <section class="mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex flex-wrap gap-4">
                        <select id="filter-category" class="px-3 py-2 border rounded-md"><option value="all">Wszystkie kategorie</option></select>
                        <select id="filter-room" class="px-3 py-2 border rounded-md"><option value="all">Wszystkie pomieszczenia</option></select>
                        <select id="sort-by" class="px-3 py-2 border rounded-md"><option value="date-desc">Sortuj: Najnowsze</option><option value="date-asc">Sortuj: Najstarsze</option><option value="cost-desc">Sortuj: Koszt malejąco</option><option value="cost-asc">Sortuj: Koszt rosnąco</option></select>
                    </div>
                    <button id="export-csv-btn" class="px-4 py-2 font-semibold text-white bg-green-600 rounded-md">Eksportuj do CSV</button>
                </section>
                <section class="card bg-white rounded-xl shadow-md border overflow-hidden">
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-xs uppercase"><tr><th class="px-6 py-3">Zdjęcie</th><th class="px-6 py-3">Nazwa</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Kategoria</th><th class="px-6 py-3">Pomieszczenie</th><th class="px-6 py-3 text-right">Budżet</th><th class="px-6 py-3 text-right">Koszt</th><th class="px-6 py-3 text-right">Różnica</th><th class="px-6 py-3 text-center">Akcje</th></tr></thead><tbody id="expense-list" class="divide-y"></tbody></table></div>
                </section>
            </div>
            <div id="page-wishlist" class="page">
                 <div id="loader-wishlist" class="loader"></div>
                 <!-- Reszta HTML dla strony wishlist -->
                 <section class="card bg-white rounded-xl shadow-md border overflow-hidden">
                    <div class="p-6"><h2 class="text-xl font-bold text-slate-900">Wasze plany i pomysły</h2></div>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-xs uppercase"><tr><th class="px-6 py-3">Zdjęcie</th><th class="px-6 py-3">Nazwa</th><th class="px-6 py-3">Kategoria</th><th class="px-6 py-3">Pomieszczenie</th><th class="px-6 py-3 text-right">Szacowany budżet</th><th class="px-6 py-3 text-center">Akcje</th></tr></thead><tbody id="wishlist-list" class="divide-y"></tbody></table></div>
                </section>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // PASTE YOUR FIREBASE CONFIG HERE
    const firebaseConfig = {
      apiKey: "AIzaSyCWdAlrZ6z91pZvKxg3x3Klt3PYMtKvuA4",
      authDomain: "budzetremontowy.firebaseapp.com",
      projectId: "budzetremontowy",
      storageBucket: "budzetremontowy.firebasestorage.app",
      messagingSenderId: "85991178574",
      appId: "1:85991178574:web:547fb6640aabf0950f1e1f",
      measurementId: "G-DD3ZY7PGB1"
    };

    <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
        <!-- NOWY SKRYPT: App Check -->
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-check-compat.js"></script>

        // Inicjalizacja Firebase
        firebase.initializeApp(firebaseConfig);
        // NOWY KOD: Inicjalizacja App Check
        const appCheck = firebase.appCheck();
        appCheck.activate(
          'deltA!0808I90072211578', // <-- WKLEJ TUTAJ SWÓJ SITE KEY
        true);
    
        const db = firebase.firestore();
        const auth = firebase.auth();
        const expensesCollection = db.collection('expenses');

        document.addEventListener('DOMContentLoaded', () => {
            // Logowanie anonimowe
            auth.signInAnonymously().catch(error => console.error("Błąd logowania anonimowego:", error));

            let localExpensesCache = []; // Lokalna kopia danych do filtrowania
            
            // --- Nasłuchuj zmian w bazie w czasie rzeczywistym ---
            expensesCollection.orderBy("createdAt", "desc").onSnapshot(snapshot => {
                document.getElementById('loader-expenses').style.display = 'none';
                document.getElementById('loader-wishlist').style.display = 'none';
                
                localExpensesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp(localExpensesCache);
            }, error => {
                console.error("Błąd pobierania danych z Firestore: ", error);
                alert("Nie udało się połączyć z bazą danych. Sprawdź konsolę, aby uzyskać więcej informacji.");
            });
            
            // Reszta skryptu (nawigacja, rendery, event listenery) jest podobna,
            // ale funkcje zapisu, edycji i usuwania komunikują się teraz z Firebase.

            // --- Nawigacja (bez zmian) ---
            const tabs = document.querySelectorAll('.tab');
            const pages = document.querySelectorAll('.page');
            const switchPage = (pageId) => { /* ... bez zmian ... */
                pages.forEach(page => page.classList.remove('page-active'));
                tabs.forEach(tab => tab.classList.remove('tab-active'));
                document.getElementById(`page-${pageId}`).classList.add('page-active');
                document.querySelector(`.tab[data-page="${pageId}"]`).classList.add('tab-active');
            };
            tabs.forEach(tab => tab.addEventListener('click', (e) => { e.preventDefault(); switchPage(e.target.dataset.page); }));

            // --- DOM Elements (bez zmian) ---
            const expenseForm = document.getElementById('expense-form');
            const expenseList = document.getElementById('expense-list');
            const wishlistList = document.getElementById('wishlist-list');
            const expenseIdInput = document.getElementById('expense-id');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const filterCategoryEl = document.getElementById('filter-category');
            const filterRoomEl = document.getElementById('filter-room');
            const sortByEl = document.getElementById('sort-by');
            const formInputs = { /* ... bez zmian ... */
                name: document.getElementById('name'), category: document.getElementById('category'),
                room: document.getElementById('room'), budget: document.getElementById('budget'),
                cost: document.getElementById('cost'), status: document.getElementById('status'),
                productLink: document.getElementById('productLink'), imageUrl: document.getElementById('imageUrl'),
            };
            const totalBudgetEl = document.getElementById('total-budget');
            const totalSpentEl = document.getElementById('total-spent');
            const differenceEl = document.getElementById('difference');
            const pieChartCanvas = document.getElementById('categoryPieChart').getContext('2d');
            const barChartCanvas = document.getElementById('budgetBarChart').getContext('2d');
            let categoryPieChart, budgetBarChart;
            const TOTAL_FIXED_BUDGET = 15000;
            
            // --- Utility Functions (bez zmian) ---
            const formatCurrency = (value) => new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(value || 0);
            const getStatusBadge = (status) => { /* ... bez zmian ... */
                const colors = {
                    'Na liście życzeń': 'bg-gray-200 text-gray-800', 'Do kupienia': 'bg-yellow-200 text-yellow-800',
                    'Zamówione': 'bg-blue-200 text-blue-800', 'Dostarczone / Zakończone': 'bg-green-200 text-green-800',
                };
                return `<span class="status-badge px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colors[status] || ''}">${status}</span>`;
            };
            
            // --- Core Rendering Logic ---
            const renderApp = (expenses) => {
                renderExpensePage(expenses);
                renderWishlistPage(expenses);
                renderDashboard(expenses);
                updateFilterOptions(expenses);
            };
            
            const renderDashboard = (expenses) => { /* ... bez zmian ... */
                 const totalSpent = expenses.filter(e => e.status === 'Zamówione' || e.status === 'Dostarczone / Zakończone').reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
                totalBudgetEl.textContent = formatCurrency(TOTAL_FIXED_BUDGET);
                totalSpentEl.textContent = formatCurrency(totalSpent);
                const totalDifference = TOTAL_FIXED_BUDGET - totalSpent;
                differenceEl.textContent = formatCurrency(totalDifference);
                differenceEl.className = `text-3xl font-bold mt-2 ${totalDifference >= 0 ? 'text-slate-700' : 'text-red-600'}`;
                renderCharts(expenses);
            };
            
            const renderExpensePage = (allExpenses) => { /* ... modyfikacja do użycia argumentu ... */
                let displayedExpenses = allExpenses.filter(e => e.status !== 'Na liście życzeń');
                 // Filtrowanie i sortowanie (jak wcześniej)
                 const categoryFilter = filterCategoryEl.value;
                if (categoryFilter !== 'all') displayedExpenses = displayedExpenses.filter(e => e.category === categoryFilter);
                const roomFilter = filterRoomEl.value;
                if (roomFilter !== 'all') displayedExpenses = displayedExpenses.filter(e => e.room === roomFilter);
                
                displayedExpenses.sort((a, b) => {
                    const costA = parseFloat(a.cost) || 0, costB = parseFloat(b.cost) || 0;
                    const dateA = a.createdAt.toMillis(), dateB = b.createdAt.toMillis();
                    switch (sortByEl.value) {
                        case 'date-asc': return dateA - dateB;
                        case 'cost-desc': return costB - costA;
                        case 'cost-asc': return costA - costB;
                        default: return dateB - dateA;
                    }
                });
                
                expenseList.innerHTML = '';
                 if (displayedExpenses.length === 0) {
                    expenseList.innerHTML = `<tr><td colspan="9" class="text-center text-slate-500 py-10">Brak wydatków.</td></tr>`;
                } else {
                     displayedExpenses.forEach(expense => { /* ... bez zmian ... */
                        const budget = parseFloat(expense.budget) || 0, cost = parseFloat(expense.cost) || 0;
                        const row = document.createElement('tr');
                        row.innerHTML = `<td class="px-6 py-4"><img src="${expense.imageUrl || 'https://placehold.co/60x40/e2e8f0/64748b?text=Brak'}" alt="Zdjęcie" class="h-10 w-16 object-cover rounded-md"></td><td class="px-6 py-4 font-medium">${expense.name} ${expense.productLink ? `<a href="${expense.productLink}" target="_blank" class="text-blue-500 ml-1">🔗</a>` : ''}</td><td class="px-6 py-4">${getStatusBadge(expense.status)}</td><td class="px-6 py-4">${expense.category}</td><td class="px-6 py-4">${expense.room}</td><td class="px-6 py-4 text-right">${formatCurrency(budget)}</td><td class="px-6 py-4 text-right font-semibold">${formatCurrency(cost)}</td><td class="px-6 py-4 text-right ${budget - cost >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(budget - cost)}</td><td class="px-6 py-4 text-center"><button onclick="editExpense('${expense.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Edytuj</button><button onclick="deleteExpense('${expense.id}')" class="text-red-600 hover:text-red-900">Usuń</button></td>`;
                        expenseList.appendChild(row);
                    });
                 }
            };
            
            const renderWishlistPage = (allExpenses) => { /* ... modyfikacja do użycia argumentu ... */
                 const wishlistItems = allExpenses.filter(e => e.status === 'Na liście życzeń');
                 wishlistList.innerHTML = '';
                 if (wishlistItems.length === 0) {
                     wishlistList.innerHTML = `<tr><td colspan="6" class="text-center text-slate-500 py-10">Brak pomysłów na liście życzeń.</td></tr>`;
                 } else {
                     wishlistItems.forEach(item => { /* ... bez zmian ... */
                        const row = document.createElement('tr');
                        row.innerHTML = `<td class="px-6 py-4"><img src="${item.imageUrl || 'https://placehold.co/60x40/e2e8f0/64748b?text=Brak'}" alt="Zdjęcie" class="h-10 w-16 object-cover rounded-md"></td><td class="px-6 py-4 font-medium">${item.name} ${item.productLink ? `<a href="${item.productLink}" target="_blank" class="text-blue-500 ml-1">🔗</a>` : ''}</td><td class="px-6 py-4">${item.category}</td><td class="px-6 py-4">${item.room}</td><td class="px-6 py-4 text-right">${formatCurrency(item.budget)}</td><td class="px-6 py-4 text-center"><button onclick="editExpense('${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Edytuj</button><button onclick="deleteExpense('${item.id}')" class="text-red-600 hover:text-red-900">Usuń</button></td>`;
                        wishlistList.appendChild(row);
                    });
                 }
            };

            const updateFilterOptions = (expenses) => { /* ... bez zmian ... */ };
            const renderCharts = (expenses) => { /* ... bez zmian ... */ };
            const resetForm = () => { /* ... bez zmian ... */ };

            // --- Event Handlers (MODYFIKACJA) ---
            expenseForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = expenseIdInput.value;
                const expenseData = Object.keys(formInputs).reduce((acc, key) => { acc[key] = formInputs[key].value; return acc; }, {});
                
                if (id) { // Edycja
                    expensesCollection.doc(id).update(expenseData)
                        .then(() => resetForm())
                        .catch(err => console.error("Błąd aktualizacji:", err));
                } else { // Nowy wpis
                    expenseData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    expensesCollection.add(expenseData)
                        .then(() => resetForm())
                        .catch(err => console.error("Błąd dodawania:", err));
                }
                
                if (expenseData.status === 'Na liście życzeń') { switchPage('wishlist'); } else { switchPage('expenses'); }
            });

            window.editExpense = (id) => {
                const expense = localExpensesCache.find(exp => exp.id === id); if (!expense) return;
                switchPage('expenses');
                expenseIdInput.value = expense.id;
                Object.keys(formInputs).forEach(key => formInputs[key].value = expense[key] || '');
                formTitle.textContent = 'Edytuj wpis'; submitBtn.textContent = 'Zapisz zmiany';
                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            window.deleteExpense = (id) => {
                if (confirm('Na pewno chcesz usunąć ten wpis?')) {
                    expensesCollection.doc(id).delete().catch(err => console.error("Błąd usuwania:", err));
                }
            };
            
            // --- Pozostałe Event Listenery (bez zmian) ---
            cancelEditBtn.addEventListener('click', resetForm);
            darkModeToggle.addEventListener('change', () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', darkModeToggle.checked); renderApp(localExpensesCache); });
            [filterCategoryEl, filterRoomEl, sortByEl].forEach(el => el.addEventListener('change', () => renderApp(localExpensesCache)));
            exportCsvBtn.addEventListener('click', () => { /* ... bez zmian ... */
                const headers = ["ID","Nazwa","Kategoria","Pomieszczenie","Status","Budzet","Koszt","Link","URL_Zdjecia"];
                const rows = localExpensesCache.map(e => `"${e.id}","${e.name}","${e.category}","${e.room}","${e.status}","${e.budget||0}","${e.cost||0}","${e.productLink}","${e.imageUrl}"`);
                const csv = "data:text/csv;charset=utf-8," + headers.join(',') + "\n" + rows.join("\n");
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", "wydatki_remontowe.csv");
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            });
            
            // --- Initial Load ---
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            darkModeToggle.checked = isDarkMode; if (isDarkMode) document.documentElement.classList.add('dark');
        });
    </script>
</body>
</html>
